const Fs=require("fire-fs"),CCInspectorPluginMsg=Editor.require(Editor.url("packages://cc-inspector/plugin/CCInspectorPluginMsg.js")),PluginMsg=Editor.require(Editor.url("packages://cc-inspector/core/PluginMsg.js"));Editor.require("packages://cc-inspector/panel/item.js")(),Editor.Panel.extend({style:Fs.readFileSync(Editor.url("packages://cc-inspector/panel/index.css"),"utf-8"),template:Fs.readFileSync(Editor.url("packages://cc-inspector/panel/index.html"),"utf-8"),$:{},ready(){this.plugin=new window.Vue({el:this.shadowRoot,created(){this.treeData=[],this.onLaunchDebugServer();const e=Editor.require(Editor.url("packages://cc-inspector/core/PluginMsg.js"));this.$root.$on(e.MsgInside.GetNodeInfo,function(e){e&&e.uuid&&this.webSocket.send(JSON.stringify({code:CCInspectorPluginMsg.Msg.GetNodeInfo,data:e.uuid}))}.bind(this))},init(){},data:{test:"",webSocket:null,treeData:[{name:"test1",folded:!1,position:cc.v2(100,100),anchor:cc.v2(0,0),size:cc.size(200,200),rotation:0,opacity:255,color:{r:200,g:100,b:34,a:255},skew:cc.v2(3,3),children:[{name:"children1",folded:!1,children:[{name:"children66",folded:!1},{name:"children66",folded:!1}]},{name:"children2",folded:!1},{name:"children3",folded:!1}]},{name:"test2",folded:!1,id:"11",x:1,y:2}],foldedCache:{},bulbColor:"#bfbfbf",bulbClass:""},watch:{treeData(e){}},methods:{getBulbColor(){let e="d4237a";return e=this.webSocket?"#1afa29":"#d4237a"},onBtnClickTest(){this.webSocket&&this.webSocket.send(JSON.stringify({code:CCInspectorPluginMsg.Msg.GetTreeInfo,data:null}))},onBtnClickTestData(){this.treeData=[]},onBtnClickOpenPreviewWeb(){Editor.Panel.open("cc-inspector.preview-web")},onBtnClickOpenTreeInfo(){Editor.Panel.open("cc-inspector.info")},_updateTreeInfo(){},onMsg(e){let t=JSON.parse(e),i=t.code,o=t.data;if(i===CCInspectorPluginMsg.Msg.GetTreeInfo){let e=[];for(let t=0;t<o.length;t++){let i=o[t];this.serialize(i,e)}this.treeData=e,Editor.Ipc.sendToPanel("cc-inspector.info","resetPanel")}else if(i===CCInspectorPluginMsg.Msg.GetNodeInfo){let e=this.serializeData(o);Editor.Ipc.sendToPanel("cc-inspector.info","onReceiveNodeInfo",e)}},_getPreIsFolded:e=>!0,serialize(e,t){let i=this.serializeData(e);for(let t=0;t<e.children.length;t++){let o=e.children[t];this.serialize(o,i.children)}t.push(i)},serializeData(e){return{folded:this._getPreIsFolded(e.uudi),selected:!1,uuid:e.uuid,name:e.name,active:e.active,anchor:cc.v2(e.anchorX||0,e.anchorY||0),size:cc.size(e.width||0,e.height||0),position:cc.v2(e.x||0,e.y||0),scale:cc.v2(e.scaleX||0,e.scaleY||0),skew:cc.v2(e.skewX,e.skewY),opacity:e.opacity,rotation:e.rotation,color:{r:e.color.r,g:e.color.g,b:e.color.b,a:e.color.a},children:[]}},_bulbOver(){this.bulbColor="#bfbfbf"},_bulbShake(){this.webSocket?this.bulbColor="#f4ea2a":this.bulbColor="#d4237a",this.bulbClass="bulb",setTimeout(function(){this.bulbColor="#1afa29",this.bulbClass=""}.bind(this),1100)},onLaunchDebugServer(){let e=this;new(Editor.require(Editor.url("packages://cc-inspector/node_modules/ws")).Server)({port:6543}).on("connection",function(t){this._bulbShake(),e.webSocket=t,t.on("message",function(t){e.onMsg(t)}.bind(this)),t.on("close",function(){e.webSocket=null,this.treeData=[],Editor.Ipc.sendToPanel("cc-inspector.info","resetPanel"),this._bulbOver()}.bind(this)),t.on("error",function(){e.webSocket=null,Editor.Ipc.sendToPanel("cc-inspector.info","resetPanel"),this.treeData=[],this._bulbOver()}.bind(this)),t.on("open",function(){}.bind(this))}.bind(this))},updateNodeProperty(e){if(this.webSocket&&e&&void 0!==e.code&&e.data){let t=JSON.stringify(e);this.webSocket.send(t),e.code===CCInspectorPluginMsg.Msg.Active&&this.$root.$emit(PluginMsg.MsgInside.NodeActive,e.data)}}}})},messages:{onChangeProperty(e,t){this.plugin.updateNodeProperty(t)}}});